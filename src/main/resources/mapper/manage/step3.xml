<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scyllacore.dumpWeb.commonModule.db.mapper.manage.Step3ForDriveReportRegistrationMapper">

    <insert id="insertDriveReport" parameterType="DriveReportDTO">
        INSERT INTO drive_report_tb
        (DRIVE_DATE,
         FROM_SITE,
         TO_SITE,
         ITEM,
         UNIT_PRICE,
         QUANTITY,
         MEMO,
         PAYMENT_CHK,
         PROGRESS,
         DRIVER_ID_FK,
         SUBMITTER_ID_FK,
         WRITER_ID_FK)
        VALUES (#{driveDate},
                #{fromSite},
                #{toSite},
                #{item},
                #{unitPrice},
                #{quantity},
                #{memo},
                #{paymentChk},
                #{progress},
                #{driverIdFk},
                #{submitterIdFk},
                #{writerIdFk})
    </insert>


    <update id="updateDriveReport" parameterType="DriveReportDTO">
        UPDATE drive_report_tb
        SET DRIVE_DATE = #{driveDate},
        FROM_SITE = #{fromSite},
        TO_SITE = #{toSite},
        ITEM = #{item},
        QUANTITY = #{quantity},
        MEMO = #{memo},
        PAYMENT_CHK = #{paymentChk},
        PROGRESS = #{progress},
        SUBMITTER_ID_FK = #{submitterIdFk}
        WHERE WRITER_ID_FK = #{writerIdFk}
        AND DRIVE_REPORT_ID = #{driveReportId}
        AND SUBMITTER_PAYMENT_CHK = 0
    </update>


    <delete id="deleteDriveReport">
        DELETE
        FROM drive_report_tb
        WHERE WRITER_ID_FK = #{writerIdFk}
          AND DRIVE_REPORT_ID = #{driveReportId}
          AND SUBMITTER_PAYMENT_CHK = 0
    </delete>

    <select id="selectDriveReportList" parameterType="DriveReportDTO" resultType="DriveReportDTO">
        SELECT
        DRIVE_REPORT_ID,
        DATE_FORMAT(DRIVE_DATE, '%Y.%m.%d') AS driveDate,
        FROM_SITE,
        TO_SITE,
        ITEM,
        UNIT_PRICE,
        QUANTITY,
        MEMO,
        PAYMENT_CHK,
        PROGRESS,
        SUBMITTER_ID_FK
        FROM drive_report_tb
        WHERE
        <if test="driveDate != ''">
            DRIVE_DATE BETWEEN #{driveDate} AND #{driveDate}
            AND
        </if>
        DRIVER_ID_FK = #{writerIdFk}
    </select>

    <sql id="r1">
        WITH r1 AS(
            SELECT DRIVE_REPORT_ID,
                   DATE_FORMAT(DRIVE_DATE, '%Y-%m-%d') AS DRIVE_DATE,
                   FROM_SITE,
                   TO_SITE,
                   ITEM,
                   UNIT_PRICE,
                   QUANTITY,
                   MEMO,
                   SUBMITTER_ID_FK,
                   PAYMENT_CHK,
                   PROGRESS
            FROM drive_report_tb
            WHERE DRIVER_ID_FK = ${writerIdFk}
              AND DRIVE_REPORT_ID = ${driveReportId}
        )
    </sql>


    <select id="selectDriveReport" parameterType="DriveReportDTO" resultType="DriveReportDTO">
        <include refid="r1">
            <property name="writerIdFk" value="#{writerIdFk}"/>
            <property name="driveReportId" value="#{driveReportId}"/>
        </include>

        SELECT DRIVE_REPORT_ID,
        DATE_FORMAT(DRIVE_DATE, '%Y-%m-%d') AS driveDate,
        (SELECT TEL FROM submitter_tb where SUBMITTER_ID = r1.SUBMITTER_ID_FK) AS submitterTel,
        FROM_SITE,
        TO_SITE,
        ITEM,
        UNIT_PRICE,
        QUANTITY,
        MEMO,
        SUBMITTER_ID_FK,
        PAYMENT_CHK,
        PROGRESS
        FROM r1
    </select>

    <select id="selectSubmitterList" resultType="SubmitterDTO">
        SELECT *
        FROM submitter_tb
    </select>

</mapper>